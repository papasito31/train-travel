@app.route('/find-trip', methods=['GET', 'POST'])
def find_trip():
    if request.method == 'POST':
        departure = request.form['departure_station']
        arrival = request.form['arrival_station']
        requested_time = datetime.fromisoformat(request.form['departure_time'])

        conn = sqlite3.connect('trips.db')
        c = conn.cursor()
        c.execute('SELECT departure_station, arrival_station, departure_time, nickname, contact_info FROM trips')
        trips = c.fetchall()
        conn.close()

        matches = []
        flexible_matches = []
        other_matches = []

        for trip in trips:
            trip_departure, trip_arrival, trip_time_str, nickname, contact_info = trip
            trip_time = datetime.fromisoformat(trip_time_str)

            if trip_departure.lower() == departure.lower() and trip_arrival.lower() == arrival.lower():
                time_diff = abs((trip_time - requested_time).total_seconds())

                if time_diff <= 1800:  # ±30 minutes
                    matches.append({
                        'departure_station': trip_departure,
                        'arrival_station': trip_arrival,
                        'departure_time': trip_time.strftime('%Y-%m-%d %H:%M'),
                        'nickname': nickname,
                        'contact_info': contact_info
                    })
                elif time_diff <= 7200:  # ±2 hours
                    flexible_matches.append({
                        'departure_station': trip_departure,
                        'arrival_station': trip_arrival,
                        'departure_time': trip_time.strftime('%Y-%m-%d %H:%M'),
                        'nickname': nickname,
                        'contact_info': contact_info
                    })
                elif trip_time.date() == requested_time.date():
                    other_matches.append({
                        'departure_station': trip_departure,
                        'arrival_station': trip_arrival,
                        'departure_time': trip_time.strftime('%Y-%m-%d %H:%M'),
                        'nickname': nickname,
                        'contact_info': contact_info
                    })

        return render_template(
            'match_results.html',
            matches=matches,
            flexible_matches=flexible_matches,
            other_matches=other_matches
        )

    return render_template('find_trip.html')
